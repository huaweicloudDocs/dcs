# 备份文件导入方式<a name="ZH-CN_TOPIC_0179456697"></a>

## 场景描述<a name="zh-cn_topic_0177563520_section2033617489354"></a>

当前华为云DCS支持将其他云厂商Redis、自建Redis的数据通过DCS控制台迁移到华为云Redis。

您需要先将其他云厂商Redis、自建Redis的数据备份下载到本地，然后将备份数据文件上传到华为云与DCS Redis实例同一租户下相同Region下的OBS桶中，最后在DCS控制台创建迁移任务，DCS从OBS桶中读取数据，将数据迁移到华为云Redis中。

上传OBS桶的文件支持.aof、.rdb、.zip、.tar.gz四种格式，您可以直接上传.aof和.rdb文件，也可以将.aof和.rdb文件压缩成.zip或.tar.gz文件，然后将压缩后的文件上传到OBS桶。

## 前提条件<a name="zh-cn_topic_0177563520_section393611177"></a>

-   OBS桶所在区域必须跟Redis目标实例所在区域相同。例如，OBS桶和Redis所在的区域都为“华北-北京一”。
-   上传的数据文件必须为.aof、.rdb、.zip、.tar.gz的格式。
-   如果是其他云厂商的单机版Redis和主备版Redis，您需要在备份页面创建备份任务，然后下载备份文件。
-   如果是其他云厂商的集群版Redis，在备份页面创建备份后会有多个备份文件，每个备份文件对应集群中的一个分片，需要下载所有的备份文件，然后逐个上传到OBS桶。在迁移时，需要把所有分片的备份文件选择。
-   暂不支持导入自建Redis5.0生成的rdb备份文件，如果是自建Redis3.0和Redis4.0，可以使用Redis-cli工具导出.rdb备份文件。其他云厂商Redis只能通过各云的备份页面创建备份任务导出获取，不能通过Redis-cli工具使用命令导出。
-   Cluster集群仅支持导入.rdb备份文件，不支持.aof备份文件。

## 步骤1：准备目标Redis实例<a name="zh-cn_topic_0177563520_section1128152020384"></a>

-   如果您还没有华为云Redis，请先创建，创建操作，请参考[购买Redis实例](https://support.huaweicloud.com/usermanual-dcs/dcs-zh-ug-180315001.html)。

    在创建Redis实例时，Redis实例的密码必须设置为不能包含如下特殊字符（\`\~!@\#$^&\*\(\)-\_=+\\|\{\}:,<.\>/?），否则无法创建迁移任务。

-   如果您已有华为云Redis，则不需要重复创建，但在迁移之前，您需要执行以下操作：
    1.  参考[清空Redis实例数据](https://support.huaweicloud.com/usermanual-dcs/dcs-zh-ug-180919001.html)，清空实例数据。
    2.  确认已有的Redis实例密码是否符合要求。

        在创建迁移任务时，要求Redis实例的密码不能包含如下特殊字符（\`\~!@\#$^&\*\(\)-\_=+\\|\{\}:,<.\>/?），否则无法创建迁移任务。

        如果不符合以上要求，您需要先修改目标实例的密码，使密码复杂度要求符合上述要求，具体修改操作，请参考[修改目标实例密码](https://support.huaweicloud.com/usermanual-dcs/zh-cn_topic_0042697160.html)。



当前支持迁移到Redis3.0、Redis4.0和Redis5.0，您可以根据实际情况选择。

## 步骤2：创建OBS桶并上传备份文件<a name="zh-cn_topic_0177563520_section13180105217391"></a>

1.  创建OBS桶。
    1.  登录OBS管理控制台，单击右上角的“创建桶”，系统显示如[图1](#zh-cn_topic_0177563520_fig8652145084510)所示的页面。

        **图 1**  创建桶<a name="zh-cn_topic_0177563520_fig8652145084510"></a>  
        ![](figures/创建桶.png "创建桶")

    2.  选择“区域”。

        OBS桶所在区域必须跟Redis目标实例所在区域相同。

    3.  设置“桶名称”。

        桶名称的命名规则，请满足界面的要求。

    4.  设置“存储类别”，当前支持“标准存储”、“低频访问存储”和“归档存储”。

        请不要选择“归档模式”，否则会导致备份文件迁移失败。

    5.  设置“桶策略”，您可以为桶配置私有、公共读、或公共读写策略。
    6.  设置“多AZ”和“标签”，参考页面提示设置即可。
    7.  设置完成后，单击“立即创建”，等待OBS桶创建完成。

2.  通过OBS Browser客户端，上传备份数据文件到OBS桶。

    如果上传的备份文件较小，且小于50M，请执行[3](#zh-cn_topic_0177563520_li12679210144012)，通过OBS控制台上传即可；

    如果上传的备份文件大于50MB，请执行以下操作，需下载OBS Browser客户端，安装并登录，创建OBS桶，然后上传备份文件。

    1.  [设置用户权限](https://support.huaweicloud.com/clientogw-obs/obs_03_0035.html)。
    2.  [下载OBS Browser客户端](https://support.huaweicloud.com/clientogw-obs/zh-cn_topic_0045829056.html)。
    3.  [创建访问密钥（AK和SK）](https://support.huaweicloud.com/clientogw-obs/zh-cn_topic_0045829057.html)。
    4.  [登录OBS Browser客户端](https://support.huaweicloud.com/clientogw-obs/zh-cn_topic_0045829058.html)。
    5.  [添加桶](https://support.huaweicloud.com/clientogw-obs/obs_03_0022.html)。
    6.  [上传备份数据](https://support.huaweicloud.com/clientogw-obs/obs_03_0024.html)。

3.  <a name="zh-cn_topic_0177563520_li12679210144012"></a>通过OBS控制台，上传备份数据文件到OBS桶。

    如果上传的备份文件较小，且小于50M，请执如下步骤：

    1.  在OBS管理控制台的桶列表中，单击桶名称，进入“概览”页面。
    2.  在左侧导航栏，单击“对象”。
    3.  在“对象”页签下，单击“上传对象”，系统弹出“上传对象”对话框。
    4.  “上传方式”选择“批量”，单次最多支持100个文件同时上传，总大小不超过5GB。

        您可以拖拽本地文件或文件夹至“上传对象”区域框内添加待上传的文件，也可以通过单击“上传对象”区域框内的“添加文件”，选择本地文件添加。

        **图 2**  批量上传对象<a name="zh-cn_topic_0177563520_f66062090af3946f28aeb4be35be03b0a"></a>  
        ![](figures/批量上传对象.png "批量上传对象")

    5.  “上传方式”选择“单个”，上传单个文件，单个文件最大不超过50MB。

        单击![](figures/icon-more.png)按钮打开本地文件浏览器对话框，选择待上传的文件后，单击“打开”。

        **图 3**  上传单个对象<a name="zh-cn_topic_0177563520_f4ac29d2ba6724d7bb1b430eb829f36ea"></a>  
        ![](figures/上传单个对象.png "上传单个对象")

    6.  指定对象的存储类别。

        请不要选择“归档模式”，否则会导致备份文件迁移失败。

    7.  可选：勾选“KMS加密”，用于加密上传文件。

        本地备份文件上传到OBS桶，暂不支持KMS加密方式，您可不选。

    8.  单击“上传”。


## 步骤3：创建迁移任务<a name="zh-cn_topic_0177563520_section9876193816277"></a>

1.  登录分布式缓存服务控制台。
2.  单击左侧菜单栏的“数据迁移”。页面显示迁移任务列表页面。
3.  单击右上角的“创建数据迁移”。进入创建数据迁移页面。
4.  设置迁移任务名称和描述。
5.  “迁移类型”选择“备份文件导入”。

    使用备份文件导入方式时，数据来源，当前仅支持OBS桶的方式。

6.  在“OBS桶名”中选择已上传备份文件的OBS桶。

    在“备份文件”列表中显示已上传的备份数据文件，如下图所示。

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >上传的备份文件格式支持.aof、.rdb、.zip、.tar.gz，您可以上传任意其中一种。  

    **图 4**  备份文件导入<a name="zh-cn_topic_0177563520_fig16153183020419"></a>  
    ![](figures/备份文件导入.png "备份文件导入")

7.  选择需要迁移的备份文件。
8.  选择[步骤1：准备目标Redis实例](#zh-cn_topic_0177563520_section1128152020384)中创建的目标Redis。
9.  单击“立即创建”。
10. 确认迁移信息，然后单击“提交”，开始创建迁移任务。

    可返回迁移任务列表中，观察对应的迁移任务的状态，迁移成功后，任务状态显示“成功”。


